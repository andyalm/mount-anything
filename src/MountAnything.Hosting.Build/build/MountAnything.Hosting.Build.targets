<Project>
  <Target Name="BuildHost" AfterTargets="Build">
    <Error Condition="$(PowershellProviderName)==''" Text="Please set the property 'PowershellProviderName' in the $(ProjectName).csproj project" />
    <PropertyGroup>
      <StagingDir>$(IntermediateOutputPath)\Host</StagingDir>
      <HostOutputDir>$(OutputPath)\Host</HostOutputDir>
      <ImplOutputDir>$(OutputPath)\Host\Impl</ImplOutputDir>
    </PropertyGroup>
    <StageMountAnythingHostProject
      PowershellProviderName="$(PowershellProviderName)"
      ImplAssemblyName="$(AssemblyName)"
      RootNamespace="$(RootNamespace)"
      StagingDir="$(StagingDir)" />
    <MakeDir Directories="$(HostOutputDir)" />
    <ItemGroup>
      <HostProject Include="$(StagingDir)\$(PowershellProviderName).Host.csproj" />
    </ItemGroup>
    <MSBuild Projects="@(HostProject)" Targets="Restore;Build" Properties="HostingAbstractionsProjectLocation=$(HostingAbstractionsProjectLocation)" />
    <ItemGroup>
      <HostBin Include="$(StagingDir)\bin\$(Configuration)\net6.0\**\*.*" />
      <ImplBin Include="$(OutputPath)\**\*.*" Exclude="$(HostOutputDir)\**\*.*" />
      <ModuleManifest Include="$(PowershellProviderName).psd1" />
      <RootModule Include="$(PowershellProviderName).Host.dll" />
    </ItemGroup>
    <Copy SourceFiles="@(HostBin)" DestinationFiles="$(HostOutputDir)\%(RecursiveDir)%(Filename)%(Extension)" />
    <Copy SourceFiles="@(FormatFile)" DestinationFiles="$(HostOutputDir)\%(RecursiveDir)%(Filename)%(Extension)" />
    <Copy SourceFiles="@(NestedModule)" DestinationFiles="$(HostOutputDir)\%(RecursiveDir)%(Filename)%(Extension)" />
    <Copy SourceFiles="@(ImplBin)" DestinationFiles="$(ImplOutputDir)\%(RecursiveDir)%(Filename)%(Extension)" />
    <CreateModuleManifest 
      Path="@(ModuleManifest)"
      ModuleVersion="$(PackageVersion)"
      PowershellVersion="$(MinimumPowershellVersion)"
      RootModule="@(RootModule)"
      Author="$(Authors)"
      Copyright="$(Copyright)"
      Description="$(Description)"
      ReleaseNotes="$(PackageReleaseNotes)"
      FormatsToProcess="@(FormatFile)"
      NestedModules="@(NestedModule)"
      RequiredModules="@(RequiredModule)"
      FunctionsToExport="@(FunctionExport)"
      VariablesToExport="@(VariableExport)"
      CmdletsToExport="@(CmdletExport)"
      AliasesToExport="@(AliasExport)"
      WorkingDirectory="$(MSBuildProjectDirectory)\$(HostOutputDir)" />
  </Target>
</Project>